<!DOCTYPE html>
<html lang="zh-CN">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>红色问答调试</title>
   <link href='theme.css' rel='stylesheet' type='text/css'/>
   <style>
    * { box-sizing: border-box; }
    html,body{
        width: 100%;
        height: 100%;
        display: flex;
        margin: 0;
        padding: 0;
    }
    button,textarea,body,select,input{
        background-color: #e1ebe7;
        font-family: fusion-pixel-12px-monospaced-zh_hant, serif;
    }
    button:hover {
        background-color: aqua;
        color: red;
        cursor: pointer;
    }
   </style>
   <link rel="stylesheet" href="./custom_editor.css">
   <script src="axios.js"></script>
   <script src="vue.js"></script>
   <script src="vue3-sfc-loader.min.js"></script>
</head>

<body>
   
   <div id="app" style="border: 1px solid;display: flex;flex-direction: column;flex: 0 1 100%;overflow-x: auto;margin: 0.4em;">
        <h1 style="text-align: center;color: red;">红色问答调试</h1>
        <!-- START OF MODIFIED BLOCK -->
        <div style="display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 4px 8px; margin-bottom: 4px; padding: 0 0.5em;">
    <!-- 改动: 移除了 span 上的 justify-self: end; 样式，使其恢复默认左对齐 -->
    <span>平台:</span>
    <input v-model="platform" @input="change_platform">

    <span>机器人ID:</span>
    <input v-model="bot_id" @input="change_bot_id">

    <span>群组ID:</span>
    <input v-model="groups_id" @input="change_groups_id">

    <span>群ID:</span>
    <input v-model="group_id" @input="change_group_id">

    <span>用户ID:</span>
    <input v-model="user_id" @input="change_user_id">

    <span>包名(为空表示默认包):</span>
    <input v-model="pkg_name" @input="change_pkg_name">
</div>
        <!-- END OF MODIFIED BLOCK -->
        <div style="flex: 1 0 auto;height: 0;width: 100%; display: flex; flex-direction: column;">

            <custom-editor ref="child"></custom-editor>

            <div style="display: flex;flex: 1 0 auto;height: 50%;flex-direction: row;overflow: auto; border-top: 1px solid;">
                <textarea style="flex-grow: 1;min-width: 50%; border: none; outline: none;" disabled>{{result}}</textarea>
                <div v-if="has_img" style="overflow: auto;width: 0;flex-grow: 1; padding: 5px; border-left: 1px solid #ccc;">
                    <!-- 次要改动: 修正了 img 标签的样式写法，并增加了宽度和边框 -->
                    <img v-bind:src="img_src" style="max-width: 100%; object-fit: scale-down;">
                </div>
            </div>
        </div>
        <div style="display: flex;flex: 0 0 auto;">
            <button style="height: 40px;font-size: medium;font-weight: bold;flex: 1 0 auto;" @click="run_script()">发送到平台</button>
            <button style="height: 40px;font-size: medium;font-weight: bold;flex: 1 0 auto;" @click="run_script2()">直接运行</button>
        </div>
   </div>
   <script>
    const { createApp } = Vue
    const app = createApp({
        data() {
            return {
                // 用于显示
                platform:"onebot11",
                bot_id:"1736293901",
                groups_id:"556515826",
                group_id:"556515826",
                pkg_name:"",
                user_id:"",
                result:"",
                img_src:"",
                has_img:false,
            }
        },
        mounted () {

            let platform_t = window.localStorage.getItem('debug_platform');
            if (platform_t) {
                this.platform = platform_t
            }else {
                this.platform = "onebot11"
            }
            let bot_id_t = window.localStorage.getItem('debug_bot_id');
            if (bot_id_t) {
                this.bot_id = bot_id_t
            }else {
                this.bot_id = "1736293901"
            }
            let groups_id_t = window.localStorage.getItem('debug_groups_id');
            if (groups_id_t) {
                this.groups_id = groups_id_t
            }else {
                this.groups_id = ""
            }
            let group_id_t = window.localStorage.getItem('debug_group_id');
            if (group_id_t) {
                this.group_id = group_id_t
            }else {
                this.group_id = "556515826"
            }
            let user_id_t = window.localStorage.getItem('debug_user_id');
            if (user_id_t) {
                this.user_id = user_id_t
            }else {
                this.user_id = ""
            }
            let pkg_name_t = window.localStorage.getItem('debug_pkg_name');
            if (pkg_name_t) {
                this.pkg_name = pkg_name_t
            }else {
                this.pkg_name = ""
            }

        },
        methods: {
            change_platform(){
                window.localStorage.setItem('debug_platform',this.platform)
            },
            change_bot_id(){
                window.localStorage.setItem('debug_bot_id',this.bot_id)
            },
            change_group_id(){
                window.localStorage.setItem('debug_group_id',this.group_id)
            },
            change_user_id(){
                window.localStorage.setItem('debug_user_id',this.user_id)
            },
            change_groups_id(){
                window.localStorage.setItem('debug_groups_id',this.groups_id)
            },
            change_pkg_name(){
                window.localStorage.setItem('debug_pkg_name',this.pkg_name)
            },
            run_script(){
                let content = this.$refs.child.getText();
                let script = {
                    "platform":this.platform,
                    "bot_id":this.bot_id,
                    "groups_id":this.groups_id,
                    "group_id":this.group_id,
                    "user_id":this.user_id,
                    "content":content,
                    "pkg_name":this.pkg_name
                }
                this.result = "正在提交..."
                axios.post("/run_code",script)
                .then((res) => {
                    if(res.data['retcode'] == 0){
                        this.result = "请求已提交"
                    }else {
                        this.result = "提交失败：" + res.data
                    }
                })
                .catch( (error) => { // 'this' context issue fixed
                    this.result = "提交失败: " + error
                });
            },
            run_script2(){
                let content = this.$refs.child.getText();
                let script = {
                    "platform":this.platform,
                    "bot_id":this.bot_id,
                    "groups_id":this.groups_id,
                    "group_id":this.group_id,
                    "user_id":this.user_id,
                    "content":content,
                    "pkg_name":this.pkg_name
                }
                this.result = "正在执行..."
                this.has_img = false
                axios.post("/run_code_and_ret",script)
                .then((res) => {
                    if(res.data['retcode'] == 0){
                        this.result = res.data["data"]
                        var reg = /\[CQ:image,file=(.*?)(\]|\,)/;
                        let ret = reg.exec(this.result)
                        if(ret && ret.length > 1) { // Added check for ret
                            let img = ret[1].trim()
                            if(img.startsWith("base64://")) {
                                this.img_src = "data:image/jpeg;base64," + img.slice(9)
                                this.has_img = true;
                            } else {
                                let img2 = img.replaceAll("[", '[')
                                    .replaceAll("#93;", ']')
                                    .replaceAll(",", ',')
                                    .replaceAll("&", '&')
                                this.img_src = img2
                                this.has_img = true;
                            }
                        }
                        
                    }else {
                        this.result = "执行失败：" + res.data['data']
                    }
                })
                .catch((error) => { // 'this' context issue fixed
                    this.result = "执行失败: " + error
                });
            },
        },
    })
            // 动态注册 CustomEditor 组件
        const options = {
            moduleCache: {
                vue: Vue
            },
            getFile(url) {
                return fetch(url).then(res => res.ok ? res.text() : Promise.reject(res));
            },
            addStyle(textContent) {
                const style = document.createElement('style');
                style.textContent = textContent;
                document.head.appendChild(style);
            },
        };
        window['vue3-sfc-loader'].loadModule('./custom_editor.vue', options).then(CustomEditor => {
            app.component('CustomEditor', CustomEditor.default || CustomEditor);
            app.mount('#app');
        });
   </script>
   <script src="theme.js"></script>
   
</body>

</html>
